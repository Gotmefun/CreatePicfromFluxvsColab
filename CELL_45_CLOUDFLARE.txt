# Cell 4.5 - ğŸŒ Create Public URL with Cloudflare (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸ªà¸¡à¸±à¸„à¸£!)

# à¹à¸—à¸™à¸—à¸µà¹ˆ Cell 4.5 à¹€à¸”à¸´à¸¡à¸”à¹‰à¸§à¸¢à¹‚à¸„à¹‰à¸”à¸™à¸µà¹‰

import subprocess
import time
import re

print("="*60)
print("ğŸŒ Creating Public URL with Cloudflare Tunnel...")
print("="*60 + "\n")

# Download cloudflared
print("ğŸ“¥ Downloading cloudflared...\n")
!wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
!dpkg -i cloudflared-linux-amd64.deb > /dev/null 2>&1

print("âœ… Cloudflared installed!\n")

# Start tunnel
print("ğŸ“¡ Creating Cloudflare tunnel...\n")

tunnel_process = subprocess.Popen(
    ['cloudflared', 'tunnel', '--url', 'http://127.0.0.1:7860'],
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    text=True
)

# Wait and extract URL
public_url = None
print("â³ Waiting for tunnel URL...\n")

for i in range(30):  # Try for 30 seconds
    line = tunnel_process.stderr.readline()
    if 'trycloudflare.com' in line:
        # Extract URL
        match = re.search(r'https://[a-zA-Z0-9-]+\.trycloudflare\.com', line)
        if match:
            public_url = match.group(0)
            break
    time.sleep(1)

if public_url:
    print("\n" + "="*60)
    print("âœ… PUBLIC URL CREATED!")
    print("="*60)
    print("\nğŸ”— YOUR API URL:")
    print("\n" + "="*60)
    print(f"   {public_url}")
    print("="*60)
    print("\nğŸ“‹ COPY THE URL ABOVE!")
    print("\nğŸ“ How to use:")
    print("   1. Copy the URL above")
    print("   2. Go to https://aigen.ptee88.com/")
    print("   3. Settings â†’ Google Colab â†’ Paste URL")
    print("   4. Settings â†’ Enable NSFW Unlimited Mode")
    print("   5. Save & Generate!")
    print("\n" + "="*60)

    # Display as HTML
    from IPython.display import HTML, display

    html = f"""
    <div style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin: 20px 0;
      font-family: 'Google Sans', sans-serif;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    ">
      <h1 style="margin: 0 0 20px 0; font-size: 32px;">ğŸ‰ Public URL Created!</h1>
      <div style="
        background: rgba(255,255,255,0.2);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        font-size: 20px;
        font-weight: bold;
        word-break: break-all;
        font-family: 'Courier New', monospace;
      ">
        {public_url}
      </div>
      <p style="font-size: 18px; margin: 15px 0;">ğŸ“‹ Copy URL à¸™à¸µà¹‰à¹„à¸›à¹ƒà¸ªà¹ˆà¹ƒà¸™à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œ</p>
      <p style="font-size: 16px; opacity: 0.9;">https://aigen.ptee88.com/ â†’ Settings â†’ Google Colab</p>
    </div>
    """

    display(HTML(html))
else:
    print("âŒ Failed to create tunnel. Try running this cell again.")
